# Stop current build and apply fixes

# 1. Stop current process
echo "Stopping current build..."
docker compose down --volumes --remove-orphans

# 2. Update ogre-headless.cfg
cat > ogre-headless.cfg << 'EOF'
# OGRE True Headless Configuration - No Rendering System
[General]
# Use NULL render system for true headless operation
Render System=NULL Rendering Subsystem

[NULL Rendering Subsystem]
# Headless mode - no actual rendering

# Alternative minimal OpenGL (if NULL not available)
[OpenGL Rendering Subsystem]
Colour Depth=16
Display Frequency=N/A
FSAA=0
Full Screen=No
RTT Preferred Mode=Copy
VSync=No
Video Mode=800 x 600
sRGB Gamma Conversion=No
Fixed Pipeline Enabled=No
Use Multi Threaded Vertex Buffers=No
Resource Creation Policy=Create on all devices
Floating-point mode=Fastest
EOF

# 3. Update docker-compose.yaml (use the v2 version from my artifacts)
# Copy the docker_compose_v2 content I provided

# 4. Update start-services.sh (use the fixed version from my artifacts)
# Copy the fixed_start_services content I provided

# 5. Rebuild with new configuration
echo "Building with headless configuration..."
docker compose build --no-cache

# 6. Start services
echo "Starting services..."
docker compose up -d

# 7. Monitor for Gazebo GUI (should not appear)
echo "Monitoring startup..."
docker compose logs -f ros2-teaching