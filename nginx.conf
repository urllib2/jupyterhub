# Fixed Nginx Configuration for JupyterHub with Cloudflare SSL + GUI Support
events { worker_connections 1024; }
http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    upstream jupyterhub {
        server ros2-teaching-hub:8000;
    }

    upstream novnc {
        server ros2-teaching-hub:6080;
    }

    server {
        listen 80;
        server_name rosforge.com www.rosforge.com;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Optional: accept larger uploads
        client_max_body_size 100M;

        # GUI Access via noVNC - Route through JupyterHub for proper authentication
        location /desktop/ {
            proxy_pass http://jupyterhub;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 443;

            # WebSocket support for VNC
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # VNC specific settings
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
            proxy_connect_timeout 60s;
        }

        # CRITICAL: Specific handling for OAuth callback - MUST come before general location
        # Note: JupyterHub uses oauth_callback with underscore, not dash
        location = /hub/oauth_callback {
            proxy_pass http://jupyterhub;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;  # Important for Cloudflare
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 443;     # Important for HTTPS
            # Disable buffering for OAuth callbacks
            proxy_buffering off;
            proxy_request_buffering off;

            # Don't redirect OAuth callbacks
            proxy_redirect off;
        }

        # Handle all other JupyterHub routes
        location / {
            proxy_pass http://jupyterhub;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;  # Important for Cloudflare
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 443;     # Important for HTTPS

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 86400s;

            # Buffering
            proxy_buffering off;
            proxy_request_buffering off;

            # Don't redirect
            proxy_redirect off;
        }
    }
}
